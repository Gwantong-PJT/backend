<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--연결할 mapper객체(java) 연결-->
<mapper namespace="com.gwantong.project.hotplace.mapper.HotplaceMapper">

    <!--아래 type에 명시된 dto들은 application.properties의 mybatis설정에서 alias가 설정된 객체들-->
    <!--아래는 resultMap 설정. type=저장객체, id=이름, column=DB결과, property=객체의 필드-->
    
    <resultMap type="hotplaceDto" id="hotplaceDtoMap">
        <result column="hotplace_no" property="hotplaceNo"/>
        <result column="user_no" property="userNo"/>
        <result column="user_name" property="userName"/>
        <result column="hotplace_title" property="hotplaceTitle"/>
        <result column="hotplace_text" property="hotplaceText"/>
        <result column="hotplace_date" property="hotplaceDate"/>
        <result column="hotplace_views" property="hotplaceViews"/>
    </resultMap>

    <resultMap type="hotplacePictureDto" id="hotplacePictureDtoMap">
        <result column="picture_no" property="pictureNo"/>
        <result column="hotplace_no" property="hotplaceNo"/>
        <result column="picture_url" property="pictureUrl"/>
    </resultMap>

    <resultMap type="commentDto" id="commentDtoMap">
        <result column="comment_no" property="commentNo"/>
        <result column="hotplace_no" property="hotplaceNo"/>
        <result column="user_no" property="userNo"/>
        <result column="comment_text" property="commentText"/>
        <result column="comment_date" property="commentDate"/>
    </resultMap>

	<resultMap type="hotplaceDto" id="extendHotplaceDtoMap" extends="hotplaceDtoMap">
		<collection property="comments" column="hotplace_no" javaType="list" ofType="commentDto" select="commentList"/>
		<collection property="pictures" column="hotplace_no" javaType="list" ofType="hotplacePictureDto" select="pictureList"/>
	</resultMap>


    <!-- 모든 글 보기 -->
    <select id="viewAllHotplaces" resultMap="hotplaceDtoMap">
        select hotplace_no, hotplace_title, hotplace_text, hotplace_date, hotplace_views, user_no, user_name 
        from hotplaces_tb 
        left join users_tb 
        using(user_no)
    </select>
    
    <!-- 게시글 상세 확인 -->
    <select id="selectHotplace" parameterType="int" resultMap="extendHotplaceDtoMap">
        select hotplace_no, hotplace_title, hotplace_text, hotplace_date, hotplace_views, user_no, user_name
        from hotplaces_tb
        left join users_tb 
        using(user_no)
        where hotplace_no = #{hotplaceNo}
    </select>

    <!-- 게시글 상세 확인 : 댓글 조회 -->
    <select id="commentList" resultMap="commentDtoMap">
        select * from comment_tb where hotplace_no = #{hotplace_no}
    </select>

    <!-- 게시글 상세 확인 : 사진 조회 -->
    <select id="pictureList"  resultMap="hotplacePictureDtoMap">
        select * from hotplace_picture_tb where hotplace_no = #{hotplace_no}
    </select>

    <!-- 게시글 작성 -->
    <insert id="insertHotplace" parameterType="hotplaceDto">
        insert into hotplaces_tb(`user_no`, `hotplace_title`,`hotplace_text`)
        value
        (#{userNo}, #{hotplaceTitle}, #{hotplaceText});
    </insert>

    <!-- 게시글 조회수 올리기 -->
    <update id="increaseHotplaceViews" parameterType="int">
        update hotplaces_tb 
        set 
        hotplace_views = hotplace_views + 1 
        where hotplace_no = #{hotplaceNo}
    </update>

    <!-- 게시글 수정 -->
    <update id="updateHotplace" parameterType="hotplaceDto">
        update hotplaces_tb set
        hotplace_title = #{hotplaceTitle},
        hotplace_text = #{hotplaceText},
        hotplace_date = now()
        where hotplace_no = #{hotplaceNo}
    </update>

    <!-- 게시글 삭제 -->
    <delete id="deleteHotplace" parameterType="int">
        delete from hotplaces_tb where hotplace_no = #{hotplaceNo}
    </delete>

</mapper>